#!/usr/bin/with-contenv bash
 
# Set delimiter to comma
IFS=','

# Enable Meshnet, this creates the interface and connects
echo "Enabling Meshnet..."
count=0
meshnet_enabled=false

while [[ $meshnet_enabled == false && $count -lt 5 ]]; do
  result=$(nordvpn set meshnet on 2>&1)
  
  # Check for success in the output
  if [[ $result == *"uccess"* ]] || [[ $result == *"ready enabled"* ]]; then
    meshnet_enabled=true
  else
    ((count++))
    echo "Failed to enable Meshnet, retrying... ($count/5)"
    echo "Error: $result"
    echo "Current Status:"
    nordvpn status
    echo "Current Settings:"
    nordvpn settings
    sleep 5
  fi
done

if [[ $meshnet_enabled == false ]]; then
  echo "Could not enable Meshnet after 5 attempts."
  exit 1
fi

echo "Meshnet enabled successfully."

# Set nickname of this instance on the Meshnet network
if [[ -n ${NORDVPN_NICKNAME} ]]; then
  nordvpn meshnet set nickname ${NORDVPN_NICKNAME}
fi

# Iterate through Meshnet peer permissions
if [[ -n ${NORDVPN_DENY_PEER_ROUTING} ]]; then
  read -ra deny_routing <<< "${NORDVPN_DENY_PEER_ROUTING}"
  for value in "${deny_routing[@]}"; do
    nordvpn meshnet peer routing deny "$value"
  done
fi

if [[ -n ${NORDVPN_DENY_PEER_LOCAL} ]]; then
  read -ra deny_local <<< "${NORDVPN_DENY_PEER_LOCAL}"
  for value in "${deny_local[@]}"; do
    nordvpn meshnet peer local deny "$value"
  done
fi

if [[ -n ${NORDVPN_DENY_PEER_FILESHARE} ]]; then
  read -ra deny_fileshare <<< "${NORDVPN_DENY_PEER_FILESHARE}"
  for value in "${deny_fileshare[@]}"; do
    nordvpn meshnet peer fileshare deny "$value"
  done
fi

if [[ -n ${NORDVPN_DENY_PEER_REMOTE} ]]; then
  read -ra deny_remote <<< "${NORDVPN_DENY_PEER_REMOTE}"
  for value in "${deny_remote[@]}"; do
    nordvpn meshnet peer incoming deny "$value"
  done
fi

if [[ -n ${NORDVPN_ALLOW_PEER_ROUTING} ]]; then
  read -ra allow_routing <<< "${NORDVPN_ALLOW_PEER_ROUTING}"
  for value in "${allow_routing[@]}"; do
    nordvpn meshnet peer routing allow "$value"
  done
fi

if [[ -n ${NORDVPN_ALLOW_PEER_LOCAL} ]]; then
  read -ra allow_local <<< "${NORDVPN_ALLOW_PEER_LOCAL}"
  for value in "${allow_local[@]}"; do
    nordvpn meshnet peer local allow "$value"
  done
fi

if [[ -n ${NORDVPN_ALLOW_PEER_FILESHARE} ]]; then
  read -ra allow_fileshare <<< "${NORDVPN_ALLOW_PEER_FILESHARE}"
  for value in "${allow_fileshare[@]}"; do
    nordvpn meshnet peer fileshare allow "$value"
  done
fi

if [[ -n ${NORDVPN_ALLOW_PEER_REMOTE} ]]; then
  read -ra allow_remote <<< "${NORDVPN_ALLOW_PEER_REMOTE}"
  for value in "${allow_remote[@]}"; do
    nordvpn meshnet peer incoming allow "$value"
  done
fi

# Reset delimiter to default space
IFS=' '

exit 0